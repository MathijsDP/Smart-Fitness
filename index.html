<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartFitness AI | Elite Pro</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Montserrat:wght@700;900&display=swap" rel="stylesheet">

    <style>
        :root { --bg: #000; --surface: #121212; --accent: #ffffff; --sub: #8e8e93; --blue: #007aff; --success: #34c759; --danger: #ff3b30; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--accent); overflow: hidden; height: 100vh; }
        .screen { height: 100vh; display: flex; flex-direction: column; padding: 40px 25px; box-sizing: border-box; overflow-y: auto; }
        .hidden { display: none !important; }
        
        h1 { font-family: 'Montserrat'; font-size: 26px; font-weight: 900; letter-spacing: -1px; margin-bottom: 5px; }
        .subtitle { color: var(--sub); font-size: 11px; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 20px; }
        
        .card { background: var(--surface); border-radius: 16px; padding: 20px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05); }
        .btn { background: var(--accent); color: var(--bg); border: none; padding: 18px; border-radius: 12px; width: 100%; font-weight: 800; text-transform: uppercase; cursor: pointer; }
        .btn-outline { background: transparent; border: 1px solid #333; color: white; padding: 18px; border-radius: 12px; margin: 5px 0; width: 100%; text-align: left; font-weight: 600; cursor: pointer; }
        
        /* Grafieken */
        .chart-container { margin-top: 20px; }
        .chart-row { margin-bottom: 15px; }
        .chart-label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; font-weight: 600; }
        .chart-bar-bg { background: #2c2c2e; height: 8px; border-radius: 4px; overflow: hidden; }
        .chart-bar-fill { background: var(--blue); height: 100%; width: 0%; transition: width 0.5s ease; }

        /* Workout UI */
        .workout-ui { position: relative; flex: 1; border-radius: 24px; overflow: hidden; background: #000; border: 1px solid #222; }
        canvas { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .hud { position: absolute; top: 0; width: 100%; padding: 20px; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); display: flex; justify-content: space-between; z-index: 10; }
        .hud-item { text-align: center; }
        .hud-item span { display: block; font-size: 9px; color: var(--sub); font-weight: 800; }
        .hud-item strong { font-size: 18px; font-family: 'Montserrat'; }

        #rest-screen { position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        .timer-val { font-size: 80px; font-family: 'Montserrat'; font-weight: 900; color: var(--blue); }

        .nav { position: fixed; bottom: 0; width: 100%; background: rgba(18,18,18,0.95); backdrop-filter: blur(20px); display: flex; justify-content: space-around; padding: 20px 0 35px; border-top: 1px solid #222; z-index: 50; }
        .nav-item { color: var(--sub); font-size: 10px; font-weight: 700; text-transform: uppercase; cursor: pointer; }
        .nav-item.active { color: #fff; }
    </style>
</head>
<body>

    <div id="screen-onboarding" class="screen">
        <h1>PROFIEL</h1>
        <div class="subtitle">Personaliseer je coach</div>
        <input type="text" id="in-name" placeholder="NAAM">
        <input type="number" id="in-weight" placeholder="GEWICHT (KG)">
        <select id="in-level" style="width:100%; padding:16px; background:#1c1c1e; color:white; border:1px solid #333; border-radius:8px; margin-bottom:20px;">
            <option value="8">BEGINNER (8 REPS)</option>
            <option value="12">INTERMEDIATE (12 REPS)</option>
            <option value="18">ADVANCED (18 REPS)</option>
        </select>
        <button class="btn" onclick="saveUser()">START ERVARING</button>
    </div>

    <div id="screen-home" class="screen hidden">
        <h1 id="user-greeting">HELLO</h1>
        <div class="subtitle">READY FOR ACTION?</div>
        <div class="card" style="border-left: 4px solid var(--blue);">
            <h2 style="margin:0">Full Program</h2>
            <p style="color:var(--sub); font-size:13px;">Alle 20 oefeningen â€¢ 3 Sets per oefening</p>
            <button class="btn" style="margin-top:15px" onclick="nav('choice')">START WORKOUT</button>
        </div>
    </div>

    <div id="screen-choice" class="screen hidden">
        <h1>SELECTIE</h1>
        <div class="subtitle">Kies je focus voor vandaag</div>
        <button class="btn-outline" onclick="prepareWorkout('Upper')">UPPER BODY (Borst & Armen)</button>
        <button class="btn-outline" onclick="prepareWorkout('Lower')">LOWER BODY (Benen & Billen)</button>
        <button class="btn-outline" onclick="prepareWorkout('Conditie')">CONDITIE (Full Body/Cardio)</button>
    </div>

    <div id="screen-stats" class="screen hidden">
        <h1>MIJN BODY</h1>
        <div class="subtitle">XP & Levels per zone</div>
        <div class="card">
            <div class="chart-container" id="chart-area">
                </div>
        </div>
    </div>

    <div id="screen-workout" class="screen hidden" style="padding:0">
        <div class="workout-ui">
            <video id="input_video" style="display:none"></video>
            <canvas id="output_canvas"></canvas>
            
            <div id="rest-screen" class="hidden">
                <div class="subtitle">RUST - VOLGENDE SET</div>
                <div class="timer-val" id="timer-val">15</div>
                <p id="rest-info"></p>
            </div>

            <div class="hud">
                <div class="hud-item"><span>OEFENING</span><strong id="hud-exe">---</strong></div>
                <div class="hud-item"><span>SET</span><strong id="hud-set">1/3</strong></div>
                <div class="hud-item"><span>REPS</span><strong id="hud-reps">0/0</strong></div>
            </div>
        </div>
        <div style="padding:20px; background:#000;"><button class="btn" style="background:#1c1c1e; color:white" onclick="location.reload()">STOP SESSIE</button></div>
    </div>

    <nav class="nav hidden" id="navbar">
        <div class="nav-item active" onclick="nav('home', this)">Coach</div>
        <div class="nav-item" onclick="nav('stats', this)">Body</div>
        <div class="nav-item" onclick="location.reload()">Reset</div>
    </nav>

    <script>
        const exercises = {
            Upper: ["Push-up", "Incline push-up", "Pike push-up", "Diamond push-up", "Chair dips", "Superman", "Bird dog", "Plank shoulder taps", "Towel curl", "Isometric bicep hold"],
            Lower: ["Bodyweight squat", "Forward lunge", "Glute bridge", "Donkey kicks"],
            Conditie: ["Jumping jacks", "High knees", "Mountain climbers", "Burpees", "Plank", "Dead bug"]
        };

        let user = JSON.parse(localStorage.getItem('elite_v3')) || { name: '', weight: 70, baseReps: 12, xp: {Upper:0, Lower:0, Conditie:0}, lvls: {Upper:1, Lower:1, Conditie:1} };
        let currentList = [], currentIdx = 0, reps = 0, sets = 1, isRest = false, stage = 'up', activeFocus = '';

        function save() { localStorage.setItem('elite_v3', JSON.stringify(user)); }

        function saveUser() {
            user.name = document.getElementById('in-name').value;
            user.weight = document.getElementById('in-weight').value;
            user.baseReps = parseInt(document.getElementById('in-level').value);
            save(); nav('home');
        }

        function nav(s, el) {
            document.querySelectorAll('.screen').forEach(x => x.classList.add('hidden'));
            document.getElementById('screen-'+s).classList.remove('hidden');
            if(user.name) document.getElementById('navbar').classList.remove('hidden');
            if(el) { document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active')); el.classList.add('active'); }
            if(s === 'home') document.getElementById('user-greeting').innerText = "HELLO " + user.name.toUpperCase();
            if(s === 'stats') renderCharts();
        }

        function renderCharts() {
            const area = document.getElementById('chart-area');
            area.innerHTML = '';
            ['Upper', 'Lower', 'Conditie'].forEach(zone => {
                const xpNeeded = user.lvls[zone] * 100;
                const pct = (user.xp[zone] / xpNeeded) * 100;
                area.innerHTML += `
                    <div class="chart-row">
                        <div class="chart-label"><span>${zone.toUpperCase()} (Lvl ${user.lvls[zone]})</span><span>${user.xp[zone]}/${xpNeeded} XP</span></div>
                        <div class="chart-bar-bg"><div class="chart-bar-fill" style="width:${pct}%"></div></div>
                    </div>`;
            });
        }

        function prepareWorkout(focus) {
            activeFocus = focus;
            currentList = exercises[focus];
            currentIdx = 0; sets = 1; reps = 0;
            nav('workout');
            startAI();
            updateHUD();
        }

        function updateHUD() {
            document.getElementById('hud-exe').innerText = currentList[currentIdx].toUpperCase();
            document.getElementById('hud-set').innerText = `${sets}/3`;
            document.getElementById('hud-reps').innerText = `${reps}/${user.baseReps}`;
        }

        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');

        function onResults(results) {
            if (!results.poseLandmarks || isRest) return;
            canvasCtx.save();
            canvasCtx.clearRect(0,0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0,0, canvasElement.width, canvasElement.height);
            
            const m = results.poseLandmarks;
            const exe = currentList[currentIdx].toLowerCase();
            let isGood = false;

            // FORM CHECK LOGICA
            if(exe.includes("squat") || exe.includes("lunge")) {
                const a = calcAngle(m[24], m[26], m[28]);
                if(a < 110) { isGood = true; stage = 'down'; }
                if(a > 160 && stage === 'down') { countRep(); stage = 'up'; }
            } else if(exe.includes("push-up") || exe.includes("dips") || exe.includes("pike")) {
                const a = calcAngle(m[11], m[13], m[15]);
                if(a < 95) { isGood = true; stage = 'down'; }
                if(a > 155 && stage === 'down') { countRep(); stage = 'up'; }
            } else {
                // Cardio/Other
                isGood = m[15].y < m[11].y; 
                if(isGood) stage = 'up';
                if(!isGood && stage === 'up') { countRep(); stage = 'down'; }
            }

            // TEKEN SKELET (Rood/Groen)
            const color = isGood ? '#34c759' : '#ff3b30';
            drawConnectors(canvasCtx, m, POSE_CONNECTIONS, {color: color, lineWidth: 4});
            drawLandmarks(canvasCtx, m, {color: '#fff', lineWidth: 1, radius: 2});
            canvasCtx.restore();
        }

        function countRep() {
            reps++; updateHUD();
            const s = new SpeechSynthesisUtterance(reps); s.lang='nl-NL'; window.speechSynthesis.speak(s);
            
            // XP verdienen
            user.xp[activeFocus] += 5;
            // Level Up Check
            let needed = user.lvls[activeFocus] * 100;
            if(user.xp[activeFocus] >= needed) {
                user.xp[activeFocus] = 0;
                user.lvls[activeFocus]++;
                speak("Level Up in " + activeFocus);
            }
            save();

            if(reps >= user.baseReps) {
                if(sets < 3) { sets++; reps = 0; startRest("Volgende Set!"); }
                else {
                    currentIndex++;
                    if(currentIndex < currentList.length) { sets = 1; reps = 0; startRest("Volgende Oefening!"); }
                    else { speak("Workout voltooid!"); location.reload(); }
                }
            }
        }

        function startRest(msg) {
            isRest = true;
            document.getElementById('rest-screen').classList.remove('hidden');
            document.getElementById('rest-info').innerText = msg;
            let t = 15;
            let iv = setInterval(() => {
                t--; document.getElementById('timer-val').innerText = t;
                if(t<=0) { clearInterval(iv); isRest=false; document.getElementById('rest-screen').classList.add('hidden'); updateHUD(); }
            }, 1000);
        }

        function calcAngle(a, b, c) {
            const r = Math.atan2(c.y-b.y, c.x-b.x) - Math.atan2(a.y-b.y, a.x-b.x);
            let ang = Math.abs(r*180/Math.PI);
            return ang > 180 ? 360-ang : ang;
        }

        function startAI() {
            const pose = new Pose({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`});
            pose.setOptions({ modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
            pose.onResults(onResults);
            const cam = new Camera(videoElement, { onFrame: async () => {
                canvasElement.width = videoElement.videoWidth; canvasElement.height = videoElement.videoHeight;
                await pose.send({image: videoElement});
            }, width: 640, height: 480 });
            cam.start();
        }

        function speak(t) { const m = new SpeechSynthesisUtterance(t); m.lang='nl-NL'; window.speechSynthesis.speak(m); }

        if(user.name) nav('home');
    </script>
</body>
</html>
