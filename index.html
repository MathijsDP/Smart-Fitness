<script>
const LINKS={
    legs:"https://teachablemachine.withgoogle.com/models/Nv8j7aUsi/",
    chest:"https://teachablemachine.withgoogle.com/models/VyHCtMsZf/"
};

let userData={};
let questionStep=0;
let model,webcam,ctx;
let reps=0,target=0,status="up",cooldown=false;

const questions=[
    {
        question:"Wat wil je trainen?",
        options:[
            {text:"Benen",value:"legs"},
            {text:"Borst",value:"chest"}
        ]
    },
    {
        question:"Wat is je niveau?",
        options:[
            {text:"Beginner",value:"beginner"},
            {text:"Gevorderd",value:"advanced"}
        ]
    }
];

window.onload = function(){
    init();
}

function init(){
    const saved=localStorage.getItem("fitnessUser");
    if(saved){
        userData=JSON.parse(saved);
        showHome();
    }else{
        showQuestion();
    }
}

function showQuestion(){
    document.getElementById("onboarding").classList.remove("hidden");
    document.getElementById("home").classList.add("hidden");

    const q=questions[questionStep];
    let html=`<h3>${q.question}</h3>`;
    q.options.forEach(opt=>{
        html+=`<button class="button" onclick="answer('${opt.value}')">${opt.text}</button>`;
    });
    document.getElementById("questionBox").innerHTML=html;
}

function answer(value){
    if(questionStep===0) userData.goal=value;
    if(questionStep===1) userData.level=value;

    questionStep++;

    if(questionStep<questions.length){
        showQuestion();
    }else{
        localStorage.setItem("fitnessUser",JSON.stringify(userData));
        showHome();
    }
}

function showHome(){
    document.getElementById("onboarding").classList.add("hidden");
    document.getElementById("home").classList.remove("hidden");

    target=userData.level==="beginner"?8:25;

    document.getElementById("todayWorkout").innerHTML=
        `<h3>Vandaag's Workout</h3>
         <p>Focus: ${userData.goal}</p>
         <p>Reps: ${target}</p>
         <button class="button" onclick="startWorkout()">Start</button>`;
}

async function startWorkout(){

    document.getElementById("home").classList.add("hidden");
    document.getElementById("workoutScreen").classList.remove("hidden");

    document.getElementById("exerciseTitle").innerText=
        userData.goal==="legs"?"Squats":"Push-ups";

    reps=0;
    document.getElementById("repCounter").innerText=`0/${target}`;

    try{
        const link=LINKS[userData.goal];

        model=await tmPose.load(link+"model.json",link+"metadata.json");

        webcam=new tmPose.Webcam(300,300,true);
        await webcam.setup();
        await webcam.play();

        const canvas=document.getElementById("canvas");
        canvas.width=300;
        canvas.height=300;
        ctx=canvas.getContext("2d");

        window.requestAnimationFrame(loop);

    }catch(e){
        alert("Camera start mislukt. Gebruik localhost.");
        console.error(e);
    }
}

async function loop(){
    webcam.update();
    await predict();
    window.requestAnimationFrame(loop);
}

async function predict(){
    const {posenetOutput}=await model.estimatePose(webcam.canvas);
    const prediction=await model.predict(posenetOutput);

    const up=prediction.find(p=>p.className==="up");
    const down=prediction.find(p=>p.className==="down");

    if(down && down.probability>0.9) status="down";

    if(up && up.probability>0.9 && status==="down" && !cooldown){
        status="up";
        cooldown=true;
        setTimeout(()=>cooldown=false,500);

        reps++;
        document.getElementById("repCounter").innerText=`${reps}/${target}`;

        if(reps>=target){
            stopWorkout();
        }
    }

    ctx.drawImage(webcam.canvas,0,0);
}

function stopWorkout(){
    if(webcam) webcam.stop();
    document.getElementById("workoutScreen").classList.add("hidden");
    showHome();
}
</script>
