<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SmartFitness Pro</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.6.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>

<style>
body{
    margin:0;
    font-family:Arial, sans-serif;
    background:#0f172a;
    color:white;
}
.app{
    max-width:500px;
    margin:auto;
    min-height:100vh;
    padding-bottom:80px;
}
.header{
    padding:20px;
    font-size:22px;
    font-weight:bold;
}
.card{
    background:#1e293b;
    margin:15px;
    padding:20px;
    border-radius:20px;
}
.button{
    width:100%;
    padding:14px;
    margin-top:10px;
    border:none;
    border-radius:12px;
    background:linear-gradient(45deg,#00e0ff,#0077ff);
    color:white;
    font-weight:bold;
    cursor:pointer;
}
.hidden{display:none;}
.bottom-nav{
    position:fixed;
    bottom:0;
    width:100%;
    max-width:500px;
    display:flex;
    background:#0b1220;
    border-top:1px solid #1f263d;
}
.nav-item{
    flex:1;
    padding:15px;
    text-align:center;
    cursor:pointer;
    color:#777;
}
.nav-item.active{
    color:#00e0ff;
}
canvas{
    width:100%;
    border-radius:15px;
    transform:scaleX(-1);
}
</style>
</head>

<body>

<div class="app">

<!-- ONBOARDING -->
<div id="onboarding">
    <div class="header">Welkom ðŸ‘‹</div>
    <div class="card" id="questionBox"></div>
</div>

<!-- HOME -->
<div id="home" class="hidden">
    <div class="header">Home</div>
    <div class="card" id="todayWorkout"></div>
</div>

<!-- WORKOUT SCREEN -->
<div id="workoutScreen" class="hidden">
    <div class="header" id="exerciseTitle"></div>
    <div class="card">
        <h2 id="repCounter">0</h2>
        <canvas id="canvas"></canvas>
        <button class="button" onclick="stopWorkout()">Stop</button>
    </div>
</div>

<!-- HISTORY -->
<div id="history" class="hidden">
    <div class="header">History</div>
    <div id="historyList"></div>
</div>

</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('home',0)">Home</div>
    <div class="nav-item" onclick="switchTab('history',1)">History</div>
</div>

<script>

const LINKS={
    legs:"https://teachablemachine.withgoogle.com/models/Nv8j7aUsi/",
    chest:"https://teachablemachine.withgoogle.com/models/VyHCtMsZf/"
};

let userData={};
let questionStep=0;
let model,webcam,ctx;
let reps=0,target=0,status="up",cooldown=false;

const questions=[
    {
        question:"Wat wil je trainen?",
        options:[
            {text:"Benen",value:"legs"},
            {text:"Borst",value:"chest"}
        ]
    },
    {
        question:"Wat is je niveau?",
        options:[
            {text:"Beginner",value:"beginner"},
            {text:"Gevorderd",value:"advanced"}
        ]
    }
];

init();

function init(){
    const saved=localStorage.getItem("fitnessUser");
    if(saved){
        userData=JSON.parse(saved);
        showHome();
    }else{
        showQuestion();
    }
}

function showQuestion(){
    const q=questions[questionStep];
    let html=`<h3>${q.question}</h3>`;
    q.options.forEach(opt=>{
        html+=`<button class="button" onclick="answer('${opt.value}')">${opt.text}</button>`;
    });
    document.getElementById("questionBox").innerHTML=html;
}

function answer(value){
    if(questionStep===0) userData.goal=value;
    if(questionStep===1) userData.level=value;

    questionStep++;

    if(questionStep<questions.length){
        showQuestion();
    }else{
        localStorage.setItem("fitnessUser",JSON.stringify(userData));
        showHome();
    }
}

function showHome(){
    hideAll();
    document.getElementById("home").classList.remove("hidden");

    target=userData.level==="beginner"?8:25;

    document.getElementById("todayWorkout").innerHTML=
        `<h3>Vandaag's Workout</h3>
         <p>Focus: ${userData.goal}</p>
         <p>Reps: ${target}</p>
         <button class="button" onclick="startWorkout()">Start Workout</button>`;
}

function switchTab(tab,index){
    document.querySelectorAll(".nav-item").forEach(n=>n.classList.remove("active"));
    document.querySelectorAll(".nav-item")[index].classList.add("active");
    hideAll();
    document.getElementById(tab).classList.remove("hidden");
    if(tab==="history") loadHistory();
}

function hideAll(){
    document.getElementById("onboarding").classList.add("hidden");
    document.getElementById("home").classList.add("hidden");
    document.getElementById("workoutScreen").classList.add("hidden");
    document.getElementById("history").classList.add("hidden");
}

async function startWorkout(){

    hideAll();
    document.getElementById("workoutScreen").classList.remove("hidden");

    document.getElementById("exerciseTitle").innerText=
        userData.goal==="legs"?"Squats":"Push-ups";

    reps=0;
    document.getElementById("repCounter").innerText=`0/${target}`;

    try{
        const link=LINKS[userData.goal];
        model=await tmPose.load(link+"model.json",link+"metadata.json");

        webcam=new tmPose.Webcam(300,300,true);
        await webcam.setup();
        await webcam.play();

        const canvas=document.getElementById("canvas");
        canvas.width=300;
        canvas.height=300;
        ctx=canvas.getContext("2d");

        window.requestAnimationFrame(loop);

    }catch(e){
        alert("Camera start mislukt. Gebruik localhost.");
        console.error(e);
    }
}

async function loop(){
    webcam.update();
    await predict();
    window.requestAnimationFrame(loop);
}

async function predict(){
    const {posenetOutput}=await model.estimatePose(webcam.canvas);
    const prediction=await model.predict(posenetOutput);

    const up=prediction.find(p=>p.className==="up");
    const down=prediction.find(p=>p.className==="down");

    if(down && down.probability>0.9) status="down";

    if(up && up.probability>0.9 && status==="down" && !cooldown){
        status="up";
        cooldown=true;
        setTimeout(()=>cooldown=false,500);

        reps++;
        document.getElementById("repCounter").innerText=`${reps}/${target}`;

        if(reps>=target){
            saveWorkout();
            stopWorkout();
        }
    }

    ctx.drawImage(webcam.canvas,0,0);
}

function stopWorkout(){
    if(webcam) webcam.stop();
    showHome();
}

function saveWorkout(){
    let history=JSON.parse(localStorage.getItem("history")||"[]");
    history.push({
        date:new Date().toLocaleDateString(),
        reps:target,
        focus:userData.goal
    });
    localStorage.setItem("history",JSON.stringify(history));
}

function loadHistory(){
    let history=JSON.parse(localStorage.getItem("history")||"[]");
    let html="";
    history.reverse().forEach(h=>{
        html+=`<div class="card">
                <b>${h.date}</b><br>
                ${h.focus} - ${h.reps} reps
               </div>`;
    });
    document.getElementById("historyList").innerHTML=html;
}

</script>

</body>
</html>
