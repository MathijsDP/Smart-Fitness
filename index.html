<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartFitness AI | Elite Coach Pro</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Montserrat:wght@700;900&display=swap" rel="stylesheet">

    <style>
        :root { --bg: #000; --surface: #121212; --accent: #ffffff; --sub: #8e8e93; --blue: #007aff; --success: #34c759; --danger: #ff3b30; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--accent); overflow: hidden; height: 100vh; }
        .screen { height: 100vh; display: flex; flex-direction: column; padding: 40px 25px; box-sizing: border-box; overflow-y: auto; }
        .hidden { display: none !important; }
        
        h1 { font-family: 'Montserrat'; font-size: 26px; font-weight: 900; letter-spacing: -1px; margin-bottom: 5px; }
        .subtitle { color: var(--sub); font-size: 11px; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 25px; }
        
        /* Premium UI */
        .card { background: var(--surface); border-radius: 20px; padding: 25px; margin-bottom: 15px; border: 1px solid #222; }
        .btn { background: var(--accent); color: var(--bg); border: none; padding: 20px; border-radius: 12px; width: 100%; font-weight: 800; text-transform: uppercase; cursor: pointer; }
        .btn-outline { background: transparent; border: 1px solid #333; color: white; padding: 18px; border-radius: 12px; margin: 8px 0; width: 100%; text-align: left; display: flex; justify-content: space-between; }

        /* Workout HUD */
        .workout-container { position: relative; flex: 1; border-radius: 30px; overflow: hidden; background: #000; border: 1px solid #222; }
        canvas { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .hud { position: absolute; top: 0; width: 100%; padding: 20px; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); display: flex; justify-content: space-between; z-index: 10; }
        .hud-stat { text-align: center; }
        .hud-stat span { display: block; font-size: 9px; color: var(--sub); font-weight: 800; }
        .hud-stat strong { font-size: 18px; font-family: 'Montserrat'; }

        /* Overlays */
        #overlay-screen { position: absolute; inset: 0; background: rgba(0,0,0,0.96); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px; }
        .timer-big { font-size: 90px; font-family: 'Montserrat'; font-weight: 900; color: var(--blue); margin: 10px 0; }
        .instruction { font-size: 16px; color: var(--accent); max-width: 280px; margin-top: 15px; font-weight: 400; line-height: 1.4; }

        /* Nav */
        .nav { position: fixed; bottom: 0; width: 100%; background: rgba(10,10,10,0.95); backdrop-filter: blur(20px); display: flex; justify-content: space-around; padding: 20px 0 35px; border-top: 1px solid #222; }
        .nav-item { color: var(--sub); font-size: 10px; font-weight: 700; text-transform: uppercase; cursor: pointer; }
        .nav-item.active { color: #fff; }
    </style>
</head>
<body>

    <div id="screen-onboarding" class="screen">
        <div id="step-1">
            <h1>HOE HEET JE?</h1>
            <input type="text" id="in-name" placeholder="JE NAAM">
            <button class="btn" onclick="nextStep(2)">VOLGENDE</button>
        </div>
        <div id="step-2" class="hidden">
            <h1>GEWICHT?</h1>
            <input type="number" id="in-weight" placeholder="KG">
            <button class="btn" onclick="nextStep(3)">VOLGENDE</button>
        </div>
        <div id="step-3" class="hidden">
            <h1>NIVEAU?</h1>
            <select id="in-level">
                <option value="8">BEGINNER (8 REPS)</option>
                <option value="12">MODERAAT (12 REPS)</option>
                <option value="18">PRO (18 REPS)</option>
            </select>
            <button class="btn" onclick="finishSetup()">START COACH</button>
        </div>
    </div>

    <div id="screen-home" class="screen hidden">
        <h1 id="user-title">COACH</h1>
        <div class="subtitle">KIES JE FOCUS VOOR VANDAAG</div>
        <div class="card" onclick="startSession('Upper')">
            <strong>UPPER BODY</strong>
            <p style="color:var(--sub); font-size:12px; margin-top:5px;">6 Oefeningen • Borst, Armen, Rug</p>
        </div>
        <div class="card" onclick="startSession('Lower')">
            <strong>LOWER BODY</strong>
            <p style="color:var(--sub); font-size:12px; margin-top:5px;">4 Oefeningen • Benen, Billen</p>
        </div>
        <div class="card" onclick="startSession('Conditie')">
            <strong>CONDITIE</strong>
            <p style="color:var(--sub); font-size:12px; margin-top:5px;">4 Oefeningen • Cardio & Core</p>
        </div>
    </div>

    <div id="screen-workout" class="screen hidden" style="padding:0">
        <div class="workout-container">
            <video id="input_video" style="display:none"></video>
            <canvas id="output_canvas"></canvas>
            
            <div id="overlay-screen" class="hidden">
                <div id="rest-title" class="subtitle">VOLGENDE</div>
                <div id="exe-name-overlay" style="font-size:22px; font-weight:900;">---</div>
                <div class="timer-big" id="timer-val">30</div>
                <div class="instruction" id="exe-instruction">---</div>
            </div>

            <div class="hud">
                <div class="hud-stat"><span>PROGRES</span><strong id="hud-total">1/6</strong></div>
                <div class="hud-stat"><span>SET</span><strong id="hud-set">1/3</strong></div>
                <div class="hud-stat"><span>REPS</span><strong id="hud-reps">0/12</strong></div>
            </div>
        </div>
    </div>

    <nav class="nav hidden" id="navbar">
        <div class="nav-item active" onclick="nav('home', this)">Coach</div>
        <div class="nav-item" onclick="location.reload()">Reset</div>
    </nav>

    <script>
        const library = {
            Upper: [
                {n: "Push-up", i: "Handen onder je schouders, hou je rug zo recht als een plank."},
                {n: "Incline push-up", i: "Plaats je handen op een verhoging (bankje). Iets lichter voor de borst."},
                {n: "Superman", i: "Lig op je buik, til je armen en benen tegelijk op van de grond."},
                {n: "Pike push-up", i: "Vorm een omgekeerde V met je lichaam, druk je hoofd naar de grond."},
                {n: "Chair dips", i: "Gebruik een stoel, zak met je billen naar de grond en duw jezelf op."},
                {n: "Diamond push-up", i: "Maak een ruit met je handen onder je borst."},
                {n: "Plank shoulder taps", i: "Tik in plankhouding om de beurt je schouders aan."},
                {n: "Isometric bicep hold", i: "Hou je armen in een hoek van 90 graden vast."}
            ],
            Lower: [
                {n: "Bodyweight squat", i: "Zak door je knieën alsof je op een onzichtbare stoel gaat zitten."},
                {n: "Forward lunge", i: "Zet een grote stap vooruit en zak tot je achterste knie de grond bijna raakt."},
                {n: "Glute bridge", i: "Lig op je rug, duw je heupen zo hoog mogelijk naar het plafond."},
                {n: "Donkey kicks", i: "Op handen en knieën, schop één been omhoog naar het plafond."}
            ],
            Conditie: [
                {n: "Jumping jacks", i: "Spring met je benen wijd en breng je handen boven je hoofd."},
                {n: "High knees", i: "Ren ter plaatse en breng je knieën zo hoog mogelijk."},
                {n: "Mountain climbers", i: "In plankhouding, trek je knieën om de beurt snel naar je borst."},
                {n: "Burpees", i: "Zak in een squat, spring naar plank, spring terug en maak een sprong."}
            ]
        };

        let user = JSON.parse(localStorage.getItem('elite_v5')) || { name: '', baseReps: 12 };
        let activeList = [], currentIdx = 0, reps = 0, sets = 1, isResting = false, stage = 'up';

        function nextStep(n) { document.getElementById('step-1').classList.add('hidden'); document.getElementById('step-2').classList.add('hidden'); document.getElementById('step-'+n).classList.remove('hidden'); }
        function finishSetup() { user.name = document.getElementById('in-name').value; user.baseReps = parseInt(document.getElementById('in-level').value); localStorage.setItem('elite_v5', JSON.stringify(user)); nav('home'); }

        function nav(s, el) {
            document.querySelectorAll('.screen').forEach(x => x.classList.add('hidden'));
            document.getElementById('screen-'+s).classList.remove('hidden');
            if(user.name) document.getElementById('navbar').classList.remove('hidden');
            if(s === 'home') document.getElementById('user-title').innerText = "HEY " + user.name.toUpperCase();
        }

        function startSession(cat) {
            // Pak 6 random oefeningen (of alles als er minder dan 6 zijn)
            activeList = [...library[cat]].sort(() => 0.5 - Math.random()).slice(0, 6);
            currentIdx = 0; sets = 1; reps = 0;
            nav('workout');
            startAI();
            startRest(30, "START WORKOUT");
        }

        function updateHUD() {
            document.getElementById('hud-total').innerText = `${currentIdx + 1}/${activeList.length}`;
            document.getElementById('hud-set').innerText = `${sets}/3`;
            document.getElementById('hud-reps').innerText = `${reps}/${user.baseReps}`;
        }

        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');

        function onResults(results) {
            if (!results.poseLandmarks || isResting) return;
            canvasCtx.save();
            canvasCtx.clearRect(0,0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0,0, canvasElement.width, canvasElement.height);
            
            const m = results.poseLandmarks;
            const exe = activeList[currentIdx].n.toLowerCase();
            let isCorrect = false;

            if(exe.includes("squat") || exe.includes("lunge")) {
                const a = calcAngle(m[24], m[26], m[28]);
                if(a < 110) { isCorrect = true; stage = 'down'; }
                if(a > 160 && stage === 'down') { registerRep(); stage = 'up'; }
            } else if(exe.includes("push-up") || exe.includes("dips")) {
                const a = calcAngle(m[11], m[13], m[15]);
                if(a < 95) { isCorrect = true; stage = 'down'; }
                if(a > 155 && stage === 'down') { registerRep(); stage = 'up'; }
            } else {
                isCorrect = m[15].y < m[11].y;
                if(isCorrect) stage = 'up';
                if(!isCorrect && stage === 'up') { registerRep(); stage = 'down'; }
            }

            drawConnectors(canvasCtx, m, POSE_CONNECTIONS, {color: isCorrect ? '#34c759' : '#ff3b30', lineWidth: 5});
            canvasCtx.restore();
        }

        function registerRep() {
            reps++; updateHUD(); speak(reps);
            if(reps >= user.baseReps) {
                if(sets < 3) {
                    sets++; reps = 0;
                    startRest(15, "VOLGENDE SET");
                } else {
                    currentIdx++;
                    if(currentIdx < activeList.length) {
                        sets = 1; reps = 0;
                        startRest(30, "VOLGENDE OEFENING");
                    } else {
                        speak("Training voltooid. Goed gewerkt!");
                        nav('home');
                    }
                }
            }
        }

        function startRest(duration, title) {
            isResting = true;
            const overlay = document.getElementById('overlay-screen');
            overlay.classList.remove('hidden');
            document.getElementById('rest-title').innerText = title;
            document.getElementById('exe-name-overlay').innerText = activeList[currentIdx].n.toUpperCase();
            document.getElementById('exe-instruction').innerText = activeList[currentIdx].i;
            
            let t = duration;
            document.getElementById('timer-val').innerText = t;
            
            let timer = setInterval(() => {
                t--;
                document.getElementById('timer-val').innerText = t;
                if(t <= 0) {
                    clearInterval(timer);
                    isResting = false;
                    overlay.classList.add('hidden');
                    updateHUD();
                    speak(activeList[currentIdx].n + ". Begin maar.");
                }
            }, 1000);
        }

        function calcAngle(a, b, c) {
            const r = Math.atan2(c.y-b.y, c.x-b.x) - Math.atan2(a.y-b.y, a.x-b.x);
            let ang = Math.abs(r*180/Math.PI);
            return ang > 180 ? 360-ang : ang;
        }

        function startAI() {
            const pose = new Pose({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`});
            pose.setOptions({ modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
            pose.onResults(onResults);
            new Camera(videoElement, { onFrame: async () => {
                canvasElement.width = videoElement.videoWidth; canvasElement.height = videoElement.videoHeight;
                await pose.send({image: videoElement});
            }, width: 640, height: 480 }).start();
        }

        function speak(t) { const m = new SpeechSynthesisUtterance(t); m.lang='nl-NL'; window.speechSynthesis.speak(m); }
        if(user.name) nav('home');
    </script>
</body>
</html>
